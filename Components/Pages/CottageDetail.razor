@page "/cottage/{CottageCode:int}"
@using CottageFinder.Services
@using CottageFinder.Models
@inject APIService ApiService
@inject NavigationManager Navigation
@inject CottageStateService StateService

<div class="cottage-detail-container">
    @if (isLoading)
    {
        <div class="loading-container">
            <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
            <MudText Typo="Typo.body1" Class="mt-4">Loading cottage details...</MudText>
        </div>
    }
    else if (cottage != null)
    {
        <div class="cottage-detail-header">
            <div class="cottage-detail-header-top">
                <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                              Color="Color.Primary"
                              OnClick="GoBack"
                              Size="Size.Medium" />
                <MudText Typo="Typo.body1">Back to Cottages</MudText>
            </div>
            <MudText Typo="Typo.h5" Class="cottage-detail-title mt-2">@cottage.Name</MudText>
        </div>

        <div class="cottage-detail-content">
            <div class="cottage-detail-image-section">
                @if (!string.IsNullOrEmpty(cottage.PictureUrl))
                {
                    <img src="@cottage.PictureUrl" alt="@cottage.Name" class="cottage-detail-image" />
                }
                else
                {
                    <div class="cottage-detail-no-image">No Image Available</div>
                }
            </div>

            <div class="cottage-detail-info">
                @* Navigate to Cottage Button *@
                <MudButton Variant="Variant.Filled"
                          Color="Color.Primary"
                          StartIcon="@Icons.Material.Filled.Explore"
                          Size="Size.Large"
                          FullWidth="true"
                          Class="mb-4"
                          OnClick="NavigateToCottage">
                    Navigate to Cottage
                </MudButton>

                <MudCard Class="mb-4">
                    <MudCardContent>
                        <MudText Typo="Typo.h6" Class="mb-3">Quick Details</MudText>
                        <div class="detail-grid">
                        <div class="detail-item">
                            <strong>Location:</strong>
                            <span>@cottage.Town</span>
                        </div>
                        @if (!string.IsNullOrEmpty(cottage.TownDistance))
                        {
                            <div class="detail-item">
                                <strong>Distance:</strong>
                                <span>@cottage.TownDistance</span>
                            </div>
                        }
                        <div class="detail-item">
                            <strong>Accommodation:</strong>
                            <span>@cottage.SleepsText</span>
                        </div>
                        <div class="detail-item">
                            <strong>Bedrooms:</strong>
                            <span>@cottage.Bedrooms</span>
                        </div>
                        @if (cottage.MaxAdults > 0)
                        {
                            <div class="detail-item">
                                <strong>Max Adults:</strong>
                                <span>@cottage.MaxAdults</span>
                            </div>
                        }
                        @if (cottage.MaxPets > 0)
                        {
                            <div class="detail-item">
                                <strong>Pets Welcome:</strong>
                                <span>Up to @cottage.MaxPets pet@(cottage.MaxPets > 1 ? "s" : "")</span>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(cottage.Changeover))
                        {
                            <div class="detail-item">
                                <strong>Changeover Day:</strong>
                                <span>@cottage.Changeover</span>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(cottage.RentPeriod))
                        {
                            <div class="detail-item">
                                <strong>Rental Period:</strong>
                                <span>@cottage.RentPeriod</span>
                            </div>
                        }
                    </div>
                    </MudCardContent>
                </MudCard>

                @if (!string.IsNullOrEmpty(cottage.Rent))
                {
                    <MudCard Class="mb-4 pricing-card-mud">
                        <MudCardContent>
                            <MudText Typo="Typo.h6" Class="mb-3">Pricing</MudText>
                        <div class="price-display">
                            <span class="main-price">@cottage.Rent</span>
                            @if (cottage.MinRent != cottage.MaxRent && cottage.MinRent > 0 && cottage.MaxRent > 0)
                            {
                                <div class="price-range">
                                    <small>Range: £@cottage.MinRent.ToString("F0") - £@cottage.MaxRent.ToString("F0")</small>
                                </div>
                            }
                        </div>
                        </MudCardContent>
                    </MudCard>
                }

                @if (!string.IsNullOrEmpty(cottage.IntroText))
                {
                    <MudCard Class="mb-4">
                        <MudCardContent>
                            <MudText Typo="Typo.h6" Class="mb-3">Description</MudText>
                            <div class="description-text">
                                @((MarkupString)FormatIntroText(cottage.IntroText))
                            </div>
                        </MudCardContent>
                    </MudCard>
                }

                @if (cottage.SpecialOffers?.Any() == true)
                {
                    <MudCard Class="mb-4 offers-card-mud">
                        <MudCardContent>
                            <MudText Typo="Typo.h6" Class="mb-3">Special Offers</MudText>
                        <div class="offers-list">
                            @foreach (var offer in cottage.SpecialOffers)
                            {
                                <div class="offer-item">
                                    @if (!string.IsNullOrEmpty(offer.Title))
                                    {
                                        <h4 class="offer-title">@offer.Title</h4>
                                    }
                                    @if (!string.IsNullOrEmpty(offer.Dates))
                                    {
                                        <p class="offer-dates"><strong>Dates:</strong> @offer.Dates</p>
                                    }
                                    @if (!string.IsNullOrEmpty(offer.PriceFull) && !string.IsNullOrEmpty(offer.PriceNow))
                                    {
                                        <div class="offer-pricing">
                                            <span class="price-was">@offer.PriceFull</span>
                                            <span class="price-now">@offer.PriceNow</span>
                                        </div>
                                    }
                                    else if (!string.IsNullOrEmpty(offer.PriceNow))
                                    {
                                        <p class="offer-price">@offer.PriceNow</p>
                                    }
                                </div>
                            }
                        </div>
                        </MudCardContent>
                    </MudCard>
                }

                <MudCard Class="mb-4">
                    <MudCardContent>
                        <MudText Typo="Typo.h6" Class="mb-3">Location Details</MudText>
                        <div class="location-info">
                            <MudText Typo="Typo.body2" Class="mb-2">
                                <strong>Coordinates:</strong> @cottage.Latitude.ToString("F6"), @cottage.Longitude.ToString("F6")
                            </MudText>
                            @if (cottage.Position.HasValue)
                            {
                                <MudText Typo="Typo.body2">
                                    <strong>Search Position:</strong> #@cottage.Position
                                </MudText>
                            }
                        </div>
                    </MudCardContent>
                </MudCard>
            </div>
        </div>
    }
    else
    {
        <div class="cottage-not-found">
            <MudAlert Severity="Severity.Warning" Class="mb-4">
                <MudText Typo="Typo.h6">Cottage Not Found</MudText>
                <MudText Typo="Typo.body2">The cottage you're looking for could not be found.</MudText>
            </MudAlert>
            <MudButton Variant="Variant.Filled"
                      Color="Color.Primary"
                      StartIcon="@Icons.Material.Filled.ArrowBack"
                      OnClick="GoBack">
                Back to Cottages
            </MudButton>
        </div>
    }
</div>

@code {
    [Parameter] public int CottageCode { get; set; }
    
    private Cottage? cottage;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            Console.WriteLine($"Looking for cottage with code: {CottageCode}");
            
            // First try to get cottage from cached state
            cottage = StateService.GetCottageByCode(CottageCode);
            Console.WriteLine($"Found cottage in cache: {cottage != null}");
            
            // If not found in cache and cache is expired, fetch fresh data
            if (cottage == null && !StateService.HasValidCache)
            {
                Console.WriteLine("Cache invalid, fetching fresh data...");
                var searchResults = await ApiService.GetCottages();
                if (searchResults != null)
                {
                    Console.WriteLine($"Got {searchResults.Cottages?.Count ?? 0} cottages from API");
                    StateService.SetSearchResults(searchResults);
                    cottage = StateService.GetCottageByCode(CottageCode);
                    Console.WriteLine($"Found cottage after fresh fetch: {cottage != null}");
                    
                    // Debug: List all cottage codes
                    if (searchResults.Cottages != null)
                    {
                        var codes = string.Join(", ", searchResults.Cottages.Select(c => c.Code.ToString()));
                        Console.WriteLine($"Available cottage codes: {codes}");
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading cottage details: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/cottages");
    }

    private void NavigateToCottage()
    {
        if (cottage != null)
        {
            Navigation.NavigateTo($"/compass/{cottage.Code}");
        }
    }

    private string FormatIntroText(string introText)
    {
        if (string.IsNullOrEmpty(introText))
            return string.Empty;

        // Replace &#xD;&#xA; with proper line breaks
        var formatted = introText.Replace("&#xD;&#xA;", "<br/><br/>");
        
        // Handle any other common HTML entities
        formatted = formatted.Replace("&amp;", "&");
        formatted = formatted.Replace("&lt;", "<");
        formatted = formatted.Replace("&gt;", ">");
        formatted = formatted.Replace("&quot;", "\"");
        
        return formatted;
    }
}