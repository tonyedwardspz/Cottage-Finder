@page "/location"
@using CottageFinder.Interfaces
@using Microsoft.Maui.Devices.Sensors
@inject ILocationService LocationService
@implements IDisposable

<PageTitle>My Location</PageTitle>

<div class="location-page-container">
    @* Header *@
    <div class="location-page-header">
        <MudText Typo="Typo.h5" Class="mb-2">My Location</MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary">Track your GPS position and sensor data</MudText>
    </div>

    @* Tracking Controls *@
    <MudCard Class="mb-4">
        <MudCardContent>
            <div class="tracking-controls">
                <div class="tracking-status">
                    <MudIcon Icon="@(isMonitoring ? Icons.Material.Filled.GpsFixed : Icons.Material.Filled.GpsOff)"
                            Color="@(isMonitoring ? Color.Success : Color.Default)"
                            Size="Size.Large" />
                    <div>
                        <MudText Typo="Typo.h6">Tracking Status</MudText>
                        <MudText Typo="Typo.body2" Color="@(isMonitoring ? Color.Success : Color.Default)">
                            @(isMonitoring ? "Monitoring" : "Stopped")
                        </MudText>
                    </div>
                </div>
                <div class="tracking-buttons">
                    <MudButton Variant="Variant.Filled"
                              Color="@(isMonitoring ? Color.Error : Color.Success)"
                              StartIcon="@(isMonitoring ? Icons.Material.Filled.Stop : Icons.Material.Filled.PlayArrow)"
                              OnClick="ToggleLocationTracking"
                              FullWidth="true"
                              Class="@(isMonitoring ? "" : "mb-2")">
                        @(isMonitoring ? "Stop Tracking" : "Start Tracking")
                    </MudButton>

                    @if (!isMonitoring)
                    {
                        <MudButton Variant="Variant.Outlined"
                                  Color="Color.Primary"
                                  StartIcon="@Icons.Material.Filled.MyLocation"
                                  OnClick="GetCurrentLocation"
                                  Disabled="@isGettingLocation"
                                  FullWidth="true">
                            @if (isGettingLocation)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                <span>Getting location...</span>
                            }
                            else
                            {
                                <span>Get Current Location</span>
                            }
                        </MudButton>
                    }
                </div>
            </div>
        </MudCardContent>
    </MudCard>

    @* Sensor Data *@
    @if (currentLocation != null)
    {
        <MudText Typo="Typo.h6" Class="mb-3">Sensor Data</MudText>

        <MudGrid Spacing="3" Class="mb-4">
            @* GPS Coordinates *@
            <MudItem xs="12" sm="6">
                <MudCard>
                    <MudCardContent>
                        <div class="sensor-data-item">
                            <MudIcon Icon="@Icons.Material.Filled.LocationOn" Color="Color.Primary" Size="Size.Large" />
                            <div>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">GPS Coordinates</MudText>
                                <MudText Typo="Typo.body1"><strong>@currentLocation.Latitude.ToString("F6")°</strong></MudText>
                                <MudText Typo="Typo.body2">@currentLocation.Longitude.ToString("F6")°</MudText>
                            </div>
                        </div>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            @* Altitude *@
            <MudItem xs="12" sm="6">
                <MudCard>
                    <MudCardContent>
                        <div class="sensor-data-item">
                            <MudIcon Icon="@Icons.Material.Filled.Terrain" Color="Color.Info" Size="Size.Large" />
                            <div>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Altitude</MudText>
                                <MudText Typo="Typo.body1">
                                    <strong>@(currentLocation.Altitude.HasValue ? $"{currentLocation.Altitude.Value:F2} m" : "N/A")</strong>
                                </MudText>
                            </div>
                        </div>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            @* Accuracy *@
            <MudItem xs="12" sm="6">
                <MudCard>
                    <MudCardContent>
                        <div class="sensor-data-item">
                            <MudIcon Icon="@Icons.Material.Filled.GpsFixed" Color="Color.Success" Size="Size.Large" />
                            <div>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Accuracy</MudText>
                                <MudText Typo="Typo.body1">
                                    <strong>@(currentLocation.Accuracy.HasValue ? $"±{currentLocation.Accuracy.Value:F1} m" : "N/A")</strong>
                                </MudText>
                            </div>
                        </div>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            @* Speed *@
            <MudItem xs="12" sm="6">
                <MudCard>
                    <MudCardContent>
                        <div class="sensor-data-item">
                            <MudIcon Icon="@Icons.Material.Filled.Speed" Color="Color.Warning" Size="Size.Large" />
                            <div>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Speed</MudText>
                                <MudText Typo="Typo.body1">
                                    <strong>@(currentLocation.Speed.HasValue ? $"{currentLocation.Speed.Value:F2} m/s" : "N/A")</strong>
                                </MudText>
                            </div>
                        </div>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            @* Course/Heading *@
            <MudItem xs="12" sm="6">
                <MudCard>
                    <MudCardContent>
                        <div class="sensor-data-item">
                            <MudIcon Icon="@Icons.Material.Filled.Explore" Color="Color.Secondary" Size="Size.Large" />
                            <div>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Course</MudText>
                                <MudText Typo="Typo.body1">
                                    <strong>@(currentLocation.Course.HasValue ? $"{currentLocation.Course.Value:F1}°" : "N/A")</strong>
                                </MudText>
                            </div>
                        </div>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            @* Last Update Time *@
            <MudItem xs="12" sm="6">
                <MudCard>
                    <MudCardContent>
                        <div class="sensor-data-item">
                            <MudIcon Icon="@Icons.Material.Filled.AccessTime" Color="Color.Default" Size="Size.Large" />
                            <div>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Last Update</MudText>
                                <MudText Typo="Typo.body1"><strong>@lastUpdateTime.ToString("HH:mm:ss")</strong></MudText>
                            </div>
                        </div>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>
    }
    else
    {
        <MudAlert Severity="Severity.Info" Class="mb-4">
            No location data available. Start tracking or get current location to see sensor data.
        </MudAlert>
    }

    @* Location History *@
    @if (locationHistory.Any())
    {
        <MudCard>
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Location History</MudText>
                </CardHeaderContent>
                <CardHeaderActions>
                    <MudChip T="string" Text="@($"{locationHistory.Count} updates")" Size="Size.Small" Color="Color.Primary" />
                </CardHeaderActions>
            </MudCardHeader>
            <MudCardContent>
                <MudList T="string" Dense="true">
                    @foreach (var item in locationHistory.Take(10))
                    {
                        <MudListItem T="string" Icon="@Icons.Material.Filled.LocationOn">
                            <div class="history-item-content">
                                <MudText Typo="Typo.body2">
                                    <strong>@item.Time.ToString("HH:mm:ss")</strong>
                                </MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @item.Location.Latitude.ToString("F4")°, @item.Location.Longitude.ToString("F4")°
                                </MudText>
                            </div>
                        </MudListItem>
                        @if (item != locationHistory.Take(10).Last())
                        {
                            <MudDivider />
                        }
                    }
                </MudList>
            </MudCardContent>
        </MudCard>
    }
</div>

@code {
    private Location? currentLocation;
    private bool isMonitoring = false;
    private bool isGettingLocation = false;
    private DateTime lastUpdateTime = DateTime.Now;
    private List<(DateTime Time, Location Location)> locationHistory = new();

    protected override void OnInitialized()
    {
     LocationService.LocationChanged += OnLocationChanged;
        LocationService.LocationStatusChanged += OnLocationStatusChanged;
    }

    private async Task ToggleLocationTracking()
    {
   var result = await LocationService.ToggleLocationUpdatesAsync();
        StateHasChanged();
    }

    private async Task GetCurrentLocation()
    {
        isGettingLocation = true;
        StateHasChanged();

        try
        {
            var location = await LocationService.GetCurrentLocationAsync();
            if (location != null)
            {
                currentLocation = location;
                lastUpdateTime = DateTime.Now;
                AddToHistory(location);
            }
        }
        finally
        {
            isGettingLocation = false;
            StateHasChanged();
        }
    }

    private void OnLocationChanged(object? sender, LocationEventArgs e)
    {
        currentLocation = e.Location;
        lastUpdateTime = e.Timestamp;
        AddToHistory(e.Location);
        InvokeAsync(StateHasChanged);
    }

    private void OnLocationStatusChanged(object? sender, bool isActive)
    {
        isMonitoring = isActive;
      InvokeAsync(StateHasChanged);
    }

 private void AddToHistory(Location location)
 {
        locationHistory.Insert(0, (DateTime.Now, location));
        if (locationHistory.Count > 50) // Keep only last 50 updates
        {
     locationHistory = locationHistory.Take(50).ToList();
        }
    }

    public void Dispose()
    {
    LocationService.LocationChanged -= OnLocationChanged;
        LocationService.LocationStatusChanged -= OnLocationStatusChanged;
  }
}