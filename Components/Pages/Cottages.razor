@page "/"
@page "/cottages"
@using CottageFinder.Services
@using CottageFinder.Models
@using CottageFinder.Components.CottageList
@inject APIService ApiService
@inject NavigationManager Navigation
@inject CottageStateService StateService

<div class="home-container">
    <MudCard Class="welcome-card" Elevation="2">
        <MudCardContent>
            <MudText Typo="Typo.h4" Color="Color.Primary" Class="mb-2">Welcome to Cottage Finder</MudText>
            <MudText Typo="Typo.body1" Color="Color.Secondary">
                Discover your perfect getaway from our curated collection of cottages
            </MudText>
        </MudCardContent>
    </MudCard>

    @if (isLoading)
    {
        <div class="loading-container">
            <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
            <MudText Typo="Typo.body1" Class="mt-4">Loading cottages...</MudText>
        </div>
    }
    else if (searchResults?.Cottages?.Any() == true)
    {
        <CottageList Cottages="@searchResults.Cottages"
                     TotalCount="@searchResults.Total"
                     OnCottageSelected="NavigateToCottageDetail" />
    }
    else
    {
        <MudAlert Severity="Severity.Info" Class="mt-4">
            No cottages found. Please try again later.
        </MudAlert>
    }
</div>

@code {
    private SearchResults? searchResults;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Check if we have valid cached data first
            if (StateService.HasValidCache)
            {
                searchResults = StateService.CachedSearchResults;
                Console.WriteLine($"Using cached data with {searchResults?.Cottages?.Count ?? 0} cottages");
                isLoading = false;
                return;
            }

            // If no valid cache, fetch fresh data
            Console.WriteLine("Fetching fresh cottage data...");
            searchResults = await ApiService.GetCottages();
            Console.WriteLine($"Received {searchResults?.Cottages?.Count ?? 0} cottages from API");
            
            // Cache the results for other components to use
            if (searchResults != null)
            {
                StateService.SetSearchResults(searchResults);
                Console.WriteLine("Cached search results");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading cottages: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void NavigateToCottageDetail(int cottageCode)
    {
        Console.WriteLine($"Navigating to cottage detail for code: {cottageCode}");
        Navigation.NavigateTo($"/cottage/{cottageCode}");
    }
}
