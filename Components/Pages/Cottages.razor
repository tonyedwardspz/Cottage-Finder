@page "/"
@page "/cottages"
@using CottageFinder.Services
@using CottageFinder.Models
@inject APIService ApiService
@inject NavigationManager Navigation
@inject CottageStateService StateService

<h1>Cottages</h1>

@if (isLoading)
{
    <div class="loading">
        <p>Loading cottages...</p>
    </div>
}
else if (searchResults?.Cottages?.Any() == true)
{
    <div class="cottages-container">
        @if (searchResults.Total.HasValue)
        {
            <p class="total-results">Found @searchResults.Total cottages</p>
        }
        
        <div class="cottages-grid">
            @foreach (var cottage in searchResults.Cottages)
            {
                <div class="cottage-card" @onclick="() => NavigateToCottageDetail(cottage.Code)">
                    @if (!string.IsNullOrEmpty(cottage.PictureUrl))
                    {
                        <img src="@cottage.PictureUrl" alt="@cottage.Name" class="cottage-image" />
                    }
                    else
                    {
                        <div class="no-image">No Image Available</div>
                    }
                    <div class="cottage-info">
                        <h3 class="cottage-title">@cottage.Name</h3>
                        <p class="cottage-location">@cottage.Town</p>
                        <p class="cottage-details">@cottage.SleepsText</p>
                        @if (!string.IsNullOrEmpty(cottage.Rent))
                        {
                            <p class="cottage-price">@cottage.Rent</p>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
}
else
{
    <div class="no-results">
        <p>No cottages found. Please try again later.</p>
    </div>
}

@code {
    private SearchResults? searchResults;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Check if we have valid cached data first
            if (StateService.HasValidCache)
            {
                searchResults = StateService.CachedSearchResults;
                Console.WriteLine($"Using cached data with {searchResults?.Cottages?.Count ?? 0} cottages");
                isLoading = false;
                return;
            }

            // If no valid cache, fetch fresh data
            Console.WriteLine("Fetching fresh cottage data...");
            searchResults = await ApiService.GetCottages();
            Console.WriteLine($"Received {searchResults?.Cottages?.Count ?? 0} cottages from API");
            
            // Cache the results for other components to use
            if (searchResults != null)
            {
                StateService.SetSearchResults(searchResults);
                Console.WriteLine("Cached search results");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading cottages: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void NavigateToCottageDetail(int cottageCode)
    {
        Console.WriteLine($"Navigating to cottage detail for code: {cottageCode}");
        Navigation.NavigateTo($"/cottage/{cottageCode}");
    }
}
